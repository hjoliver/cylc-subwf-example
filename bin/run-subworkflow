#!/bin/bash
set -eu

SUBWF_NAME="$1"

if [[ -d $CYLC_WORKFLOW_RUN_DIR/_cylc-install ]]; then 
   # main has no run-name
   #  - main => main-sub/point
   #  - foo/main => foo/main-sub/point
   SUBWF_ID=${CYLC_WORKFLOW_ID}-$SUBWF_NAME/$CYLC_TASK_CYCLE_POINT
else
   # main has a run-name
   #  - main/run1 => main-sub/run1-point
   #  - foo/main/run1 => foo/main-sub/run1-point
   RUNN=${CYLC_WORKFLOW_ID##*/}
   SUBWF_ID=${CYLC_WORKFLOW_ID%/*}-$SUBWF_NAME/${RUNN}-$CYLC_TASK_CYCLE_POINT
fi

INSTALLED_SRC_DIR="$CYLC_WORKFLOW_RUN_DIR/${SUBWF_NAME}"

# Copy the sub-worfklow source to a temp dir and "cylc install" it from there
# ("cylc install" doesn't like source files under cylc-run; and manual copy to
# the run directory would miss the niceties of "cylc install").
# TODO: tweak `cylc install` logic avoid the need for the temp source location?

TMP_SRC_DIR="${TMPDIR:-/tmp/$USER}/$SUBWF_ID"
rm -rf "$TMP_SRC_DIR" && mkdir -p "$TMP_SRC_DIR"
cp -r "$INSTALLED_SRC_DIR"/* $TMP_SRC_DIR
cylc install --no-run-name --workflow-name=$SUBWF_ID $TMP_SRC_DIR

# OR FOR MANUAL INSTALLATION:
#  SUBWF_RUN_DIR=~/cylc-run/$SUBWF_ID
#  mkdir -p $SUBWF_RUN_DIR
#  cp -r "$INSTALLED_SRC_DIR"/* $SUBWF_RUN_DIR

N_TASKS=$((1 + RANDOM % 2))
cylc message -p WARNING "Starting $SUBWF_ID with $N_TASKS tasks."

cylc play --no-detach --set="N_TASKS=$N_TASKS" $SUBWF_ID
